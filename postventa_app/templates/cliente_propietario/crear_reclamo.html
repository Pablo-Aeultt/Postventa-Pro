{% extends 'base.html' %}

{% load static %}
{% load crispy_forms_tags %}

    {% block title %}
        Crear Reclamo - Postventa Pro
    {% endblock %}

    {% block extra_css %}
    <style>
        :root {
            --color-primary: #1A4D4D;
            --color-secondary: #2A6D6D;
            --color-accent: #FFD700;
        }
        
        /* Navbar Styles */
        .navbar-custom {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 12px 0;
        }
        
        .navbar-custom .navbar-brand {
            color: white !important;
            font-weight: 700;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .navbar-custom .navbar-brand i {
            font-size: 28px;
        }
        
        .navbar-custom .nav-link {
            color: rgba(255,255,255,0.9) !important;
            font-weight: 500;
            padding: 8px 16px !important;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .navbar-custom .nav-link:hover {
            color: white !important;
            background: rgba(255,255,255,0.1);
        }
        
        .navbar-custom .nav-link.active {
            background: rgba(255,255,255,0.15);
            color: white !important;
        }
        
        .navbar-custom .dropdown-menu {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 12px;
            padding: 10px;
            margin-top: 8px;
        }
        
        .navbar-custom .dropdown-item {
            border-radius: 8px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .navbar-custom .dropdown-item:hover {
            background: #f8f9fa;
            transform: translateX(4px);
        }
        
        .navbar-custom .dropdown-divider {
            margin: 8px 0;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            color: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        /* Footer Styles */
        .footer-custom {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            padding: 30px 0;
            margin-top: 60px;
        }
        
        .footer-custom a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .footer-custom a:hover {
            color: white;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1A4D4D 0%, #2A6D6D 100%);
            min-height: 100vh;
            padding: 0;
        }
        
        .main-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0px 20px 40px 0px;
            display: grid;
            grid-template-columns: 1fr 500px;
            gap: 40px;
            align-items: start;
        }
        
        @media (max-width: 1024px) {
            .main-wrapper {
                grid-template-columns: 1fr;
            }
            .side-image-container {
                display: none;
            }
        }
        
        .form-container {
            background: white;
            border-radius: 16px;
            /* Importante: permitir que los tooltips nativos de validación se muestren fuera del contenedor */
            overflow: visible;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .side-image-container {
            position: sticky;
            top: 40px;
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            height: fit-content;
        }
        
        .side-image-container img {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .side-image-content {
            padding: 30px;
            background: linear-gradient(135deg, #1A4D4D 0%, #2A6D6D 100%);
            color: white;
        }
        
        .side-image-content h3 {
            font-size: 24px;
            margin-bottom: 15px;
            font-weight: 700;
        }
        
        .side-image-content p {
            font-size: 14px;
            line-height: 1.8;
            opacity: 0.95;
        }
        
        .side-image-content ul {
            margin-top: 20px;
            padding-left: 0;
            list-style: none;
        }
        
        .side-image-content ul li {
            padding: 10px 0;
            padding-left: 30px;
            position: relative;
            font-size: 14px;
        }
        
        .side-image-content ul li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #FFD700;
            font-weight: bold;
            font-size: 18px;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 40px 40px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-bottom: 3px solid #1A4D4D;
        }
        
        .form-header h1 {
            font-size: 20px;
            color: #666;
            font-weight: 400;
            letter-spacing: 0.5px;
        }
        
        .form-header h1 span {
            display: block;
            font-weight: 700;
            font-size: 36px;
            color: #1A4D4D;
            margin-top: 5px;
            letter-spacing: -0.5px;
        }
        
        .logo {
            width: 180px;
            height: 180px;
        }
        
        .logo video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        
        .section-header {
            background: linear-gradient(135deg, #1A4D4D 0%, #2A6D6D 100%);
            color: white;
            padding: 18px 40px;
            font-size: 18px;
            font-weight: 600;
            margin-top: 0;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 14px;
            border-left: 4px solid #FFD700;
        }
        
        .form-content {
            padding: 25px;
            background: #fafbfc;
            /* Permitir que los tooltips nativos se muestren correctamente */
            overflow: visible;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row.three-cols {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .form-row.full-width {
            grid-template-columns: 1fr;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1A4D4D;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #1A4D4D;
            box-shadow: 0 0 0 4px rgba(26, 77, 77, 0.1);
            transform: translateY(-1px);
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 12px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-option label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }
        
        .images-section {
            margin-top: 30px;
        }
        
        .image-upload-group {
            border: 2px dashed #d0d0d0;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .image-upload-group:hover {
            border-color: #1A4D4D;
            background: #f8f9fa;
            box-shadow: 0 4px 12px rgba(26, 77, 77, 0.1);
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #1A4D4D 0%, #2A6D6D 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 16px;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            margin-top: 30px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 8px 20px rgba(26, 77, 77, 0.3);
        }
        
        .btn-submit:hover {
            background: linear-gradient(135deg, #153D3D 0%, #1A4D4D 100%);
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(26, 77, 77, 0.4);
        }
        
        .btn-add-more {
            background: white;
            color: #1A4D4D;
            border: 2px solid #1A4D4D;
            padding: 14px 30px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-add-more:hover {
            background: #1A4D4D;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(26, 77, 77, 0.2);
        }
        
        .btn-remove {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 24px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-remove:hover {
            background: #c82333;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }
        
        .formset-form {
            position: relative;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .formset-form:last-child {
            border-bottom: none;
        }
        
        .errorlist {
            list-style: none;
            color: #dc3545;
            font-size: 12px;
            margin-top: 8px;
            background: #fee;
            padding: 10px 15px;
            border-radius: 6px;
            border-left: 3px solid #dc3545;
        }
        
        .alert {
            padding: 18px 24px;
            margin-bottom: 25px;
            border-radius: 12px;
            font-weight: 500;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert-success {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            color: #155724;
            border-left-color: #28a745;
        }
        
        .alert-error {
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            color: #721c24;
            border-left-color: #dc3545;
        }
        
        /* Estilos para tarjetas de técnicos */
        .tecnico-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            width: 100%;
            box-sizing: border-box;
        }
        
        .tecnico-card:hover {
            border-color: #1A4D4D;
            box-shadow: 0 6px 20px rgba(26, 77, 77, 0.15);
            transform: translateY(-3px);
        }
        
        .tecnico-card.selected {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }
        
        .tecnico-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .tecnico-foto {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1A4D4D 0%, #2A6D6D 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 22px;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .tecnico-foto img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .tecnico-info h4 {
            color: #1A4D4D;
            font-size: 16px;
            margin-bottom: 3px;
            font-weight: 600;
        }
        
        .tecnico-especialidad {
            color: #666;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        
        
        .estrellas {
            color: #FFD700;
            letter-spacing: 1px;
        }
        
        .num-reviews {
            color: #999;
            font-size: 12px;
        }
        
        .tecnico-horarios {
            margin-top: 12px;
        }
        
        .tecnico-horarios h5 {
            color: #1A4D4D;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .horario-mini {
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            margin-bottom: 5px;
            color: #666;
            border-left: 2px solid #28a745;
        }
        
        .badge-seleccionado {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #28a745;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Estilo para horario seleccionado */
        .horario-slot.selected {
            background: #2e7d32 !important;
            border-color: #1b5e20 !important;
            color: white !important;
            font-weight: bold !important;
            transform: scale(1.05) !important;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.4) !important;
        }
    </style>
    {% endblock %}

{% block content %}
    
    <div class="main-wrapper">
        <div class="form-container">
            <!-- Header -->
            <div class="form-header">
                <div>
                    <h1>
                        Gestion Postventa
                    <span>Formulario de Reclamo</span>
                </h1>
            </div>
            <div class="logo" id="logo-container">
                <video autoplay muted playsinline>
                    <source src="{% static 'postventa_app/img/logo.mp4' %}" type="video/mp4">
                    <source src="{% static 'postventa_app/img/logo.webm' %}" type="video/webm">
                </video>
            </div>
        </div>
        
        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        
        <form method="post" enctype="multipart/form-data" id="reclamo-form">
            {% csrf_token %}
            <!-- Campos ocultos para técnico y horario seleccionado -->
            <input type="hidden" name="tecnico_id" id="tecnico_id_hidden">
            <input type="hidden" name="fecha_cita" id="fecha_cita_hidden">
            <input type="hidden" name="hora_inicio" id="hora_inicio_hidden">
            <input type="hidden" name="hora_fin" id="hora_fin_hidden">

            {% load crispy_forms_tags %}
            <!-- Sección: Ubicación de la Propiedad -->
            <h2 class="section-header"> Ubicación de la Propiedad</h2>
            <div class="form-content">
                <div class="form-row">
                    <div class="form-group">
                        {{ form.proyecto|as_crispy_field }}
                       
                    </div>
                    <div class="form-group">
                        {{ form.unidad|as_crispy_field }}
                        
                    </div>
                </div>
            </div>

            <!-- Sección: Información del Reclamo -->
            <h2 class="section-header"> Información del Reclamo</h2>
            <div class="form-content">
                <div class="form-row full-width">
                    <div class="form-group" style="max-width: 350px;">
                        {{ form.categoria|as_crispy_field }}
                    </div>
                </div>
                <div class="form-row full-width">
                    <div class="form-group">
                        {{ form.descripcion|as_crispy_field }}
                        <p class="form-text text-muted">20 caracteres como mínimo*</p>

                    </div>
                </div>
            </div>
            
            <!-- Sección: Técnicos Disponibles (Dinámico con AJAX) -->
            <div id="tecnicos-section" style="display: none;">
                <h2 class="section-header"> Técnicos Disponibles</h2>
                <div class="form-content">
                    <div id="tecnicos-loading" style="text-align: center; padding: 40px; display: none;">
                        <div style="font-size: 48px; color: #1A4D4D; margin-bottom: 15px;">⏳</div>
                        <p style="color: #666; font-size: 16px;">Buscando técnicos disponibles...</p>
                    </div>
                    
                    <div id="tecnicos-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                        <!-- Los técnicos se cargarán aquí dinámicamente -->
                    </div>
                    
                    <div id="sin-tecnicos" style="display: none; text-align: center; padding: 40px; background: #fff3cd; border-radius: 12px; border-left: 4px solid #ffc107;">
                        <div style="font-size: 48px; margin-bottom: 15px;">⚠️</div>
                        <h3 style="color: #856404; margin-bottom: 10px;">Sin técnicos disponibles</h3>
                        <p style="color: #856404; font-size: 14px;">No hay técnicos disponibles para esta especialidad en este momento.<br>Tu reclamo será asignado manualmente.</p>
                    </div>
                </div>
            </div>
            
            <!-- Disclaimer Importante sobre Cobro de Visitas (aparece después de seleccionar horario) -->
            <div id="disclaimer-visita" style="display: none; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); padding: 20px 30px; border-radius: 12px; margin: 25px 0; border-left: 5px solid #ffc107; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3); animation: slideIn 0.5s ease;">
                <div style="display: flex; align-items: start; gap: 15px;">
                    <div style="flex-shrink: 0; font-size: 32px;">⚠️</div>
                    <div>
                        <h3 style="color: #856404; margin: 0 0 12px 0; font-size: 18px; font-weight: 700;">
                            Aviso Importante
                        </h3>
                        <p style="color: #856404; margin: 0 0 10px 0; font-size: 14px; line-height: 1.7;">
                            Ten en cuenta que si durante la inspección se determina que el problema reportado 
                            <strong>no está cubierto por la garantía</strong> (por ejemplo: daños por mal uso, modificaciones no autorizadas, 
                            desgaste normal, o situaciones no contempladas en la póliza de garantía), se aplicará un cargo por concepto 
                            de visita técnica.
                        </p>
                        <div style="background: white; padding: 12px 16px; border-radius: 8px; margin-top: 12px;">
                            <p style="color: #856404; margin: 0; font-size: 15px; font-weight: 700;">
                                     <strong style="color: #d63031;">Valor del cargo por concepto de visita:</strong> <span style="color: #d63031; font-size: 18px;">2 UF</span> 
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sección: Evidencia Fotográfica y Videos -->
            <h2 class="section-header"> Evidencia Fotográfica y Videos (Mínimo 1 archivo requerido)</h2>
            <div class="form-content">
                <div class="images-section" id="formset-container">
                    {{ formset.management_form }}
                    <div id="form-list">
                        {% for form_img in formset %}
                            <div class="image-upload-group formset-form" data-form-index="{{ forloop.counter0 }}">
                                <div class="form-row">
                                    <div class="form-group" style="flex: 2;">
                                        <label>{{ form_img.archivo.label }} {{ forloop.counter }} {% if forloop.counter == 1 %}<span style="color: #e74c3c;">*</span>{% endif %}</label>
                                        {{ form_img.archivo }}
                                        {{ form_img.archivo.errors }}
                                        <small style="color: #7f8c8d; font-size: 0.9em;">Formatos: JPG, PNG, MP4, MOV (Max. 50MB)</small>
                                    </div>
                                    <div class="form-group" style="flex: 1;">
                                        <label>{{ form_img.descripcion.label }}</label>
                                        {{ form_img.descripcion }}
                                        {{ form_img.descripcion.errors }}
                                    </div>
                                    {% if forloop.counter > 1 %}
                                    <div class="form-group" style="flex: 0 0 auto; align-self: flex-end;">
                                        <button type="button" class="btn-remove" onclick="removeForm(this)">
                                            ✕ Eliminar
                                        </button>
                                    </div>
                                    {% endif %}
                                </div>
                                {{ form_img.id }}
                                {{ form_img.tipo }}
                                {% if form_img.DELETE %}
                                    <div style="display:none;">{{ form_img.DELETE }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
                
                <button type="button" class="btn-add-more" id="add-more-btn" onclick="addForm()">
                    + Agregar Más Archivos
                </button>
                
                <button type="submit" class="btn-submit">Enviar Reclamo</button>
            </div>
        </form>
        </div>
        
        <!-- Imagen lateral -->
        <div class="side-image-container">
            <img src="{% static 'postventa_app/img/hombre_laptop.jpg' %}" alt="Servicio de Postventa" onerror="this.src='https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=400&h=600&fit=crop';">
            <div class="side-image-content">
                <h3>¿Cómo funciona?</h3>
                <p>Reporta tu falla y agenda una visita técnica de forma simple y rápida, como una cita médica online.</p>
                <ul>
                    <li>Completa el formulario describiendo la falla</li>
                    <li>Adjunta fotos o videos del problema</li>
                    <li>Elige un técnico disponible en tiempo real</li>
                    <li>Agenda una cita según tu disponibilidad</li>
                    <li>Recibe confirmación y seguimiento por email</li>
                    <li>Califica el servicio una vez resuelto</li>
                </ul>
            </div>
        </div>
    </div>
{%endblock %}


{% block scripts %}
    <script>
        // Función para agregar nuevos formularios dinámicamente
        function addForm() {
            const formList = document.getElementById('form-list');
            // Soportar distintos prefijos / ausencia de id en management form
            const totalForms = document.querySelector('#id_archivoevidencia_set-TOTAL_FORMS, input[name$="-TOTAL_FORMS"]');
            if (!totalForms) {
                alert('No se encontró el TOTAL_FORMS del formset.');
                return;
            }
            const currentFormCount = parseInt(totalForms.value || '0');
            const maxFormsEl = document.querySelector('#id_archivoevidencia_set-MAX_NUM_FORMS, input[name$="-MAX_NUM_FORMS"]');
            const maxFormsVal = maxFormsEl ? parseInt(maxFormsEl.value || '1000') : 1000; // fallback si no existe
            const maxForms = isNaN(maxFormsVal) ? 1000 : maxFormsVal;
            
            // Verificar si se alcanzó el máximo
            if (currentFormCount >= maxForms) {
                alert('Has alcanzado el máximo de ' + maxForms + ' archivos permitidos.');
                return;
            }
            
            // Clonar el primer formulario como plantilla
            const firstForm = document.querySelector('.formset-form');
            const newForm = firstForm.cloneNode(true);
            
            // Actualizar el índice del formulario
            const formRegex = new RegExp('archivoevidencia_set-(\\d+)-', 'g');
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, 'archivoevidencia_set-' + currentFormCount + '-');
            
            // Limpiar los valores de los inputs
            const inputs = newForm.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.type === 'file' || input.type === 'text') {
                    input.value = '';
                }
                if (input.type === 'checkbox') {
                    input.checked = false;
                }
                // Limpiar el hidden id si existe
                if (input.type === 'hidden' && /-id$/.test(input.name)) {
                    input.value = '';
                }
            });

            // Eliminar mensajes de error clonados si existen
            newForm.querySelectorAll('.errorlist').forEach(el => el.remove());
            
            // Actualizar el número del label
            const label = newForm.querySelector('label');
            if (label) {
                label.innerHTML = label.innerHTML.replace(/\d+/, currentFormCount + 1);
                // Quitar el asterisco rojo de campos adicionales
                label.innerHTML = label.innerHTML.replace(/<span[^>]*>\*<\/span>/g, '');
            }
            
            // Agregar botón de eliminar si no existe
            if (!newForm.querySelector('.btn-remove')) {
                const formRow = newForm.querySelector('.form-row');
                const removeDiv = document.createElement('div');
                removeDiv.className = 'form-group';
                removeDiv.style.cssText = 'flex: 0 0 auto; align-self: flex-end;';
                removeDiv.innerHTML = '<button type="button" class="btn-remove" onclick="removeForm(this)">✕ Eliminar</button>';
                formRow.appendChild(removeDiv);
            }
            
            // Actualizar el atributo data-form-index
            newForm.setAttribute('data-form-index', currentFormCount);
            
            // Agregar el nuevo formulario al contenedor
            formList.appendChild(newForm);
            
            // Incrementar el contador total de formularios
            totalForms.value = currentFormCount + 1;
        }
        
        // Función para eliminar formularios
        function removeForm(button) {
            const formToRemove = button.closest('.formset-form');
            const totalForms = document.querySelector('#id_archivoevidencia_set-TOTAL_FORMS, input[name$="-TOTAL_FORMS"]');
            const minFormsEl = document.querySelector('#id_archivoevidencia_set-MIN_NUM_FORMS, input[name$="-MIN_NUM_FORMS"]');
            const minForms = minFormsEl ? parseInt(minFormsEl.value) : 1; // fallback si no existe
            const currentFormCount = document.querySelectorAll('.formset-form').length;
            
            // No permitir eliminar si solo queda el mínimo requerido
            if (currentFormCount <= minForms) {
                alert('Debes mantener al menos ' + minForms + ' archivo(s).');
                return;
            }
            
            // Si el formulario tiene un ID (ya existe en la BD), marcarlo para eliminación
            const deleteCheckbox = formToRemove.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                formToRemove.style.display = 'none';
            } else {
                // Si es un formulario nuevo, simplemente eliminarlo del DOM
                formToRemove.remove();
                totalForms.value = parseInt(totalForms.value) - 1;
            }
            
            // Reindexar los formularios restantes
            reindexForms();
        }
        
        // Función para reindexar los formularios después de eliminar
        function reindexForms() {
            const forms = document.querySelectorAll('.formset-form:not([style*="display: none"])');
            forms.forEach((form, index) => {
                const formRegex = new RegExp('archivoevidencia_set-(\\d+)-', 'g');
                form.innerHTML = form.innerHTML.replace(formRegex, 'archivoevidencia_set-' + index + '-');
                form.setAttribute('data-form-index', index);
                
                // Actualizar el número en el label
                const label = form.querySelector('label');
                if (label) {
                    const labelText = label.innerHTML.replace(/(\d+)/, index + 1);
                    label.innerHTML = labelText;
                    
                    // Solo el primer formulario debe tener asterisco rojo
                    if (index === 0) {
                        if (!label.innerHTML.includes('style="color: #e74c3c;">*</span>')) {
                            label.innerHTML = label.innerHTML.replace(/(\d+)/, '$1 <span style="color: #e74c3c;">*</span>');
                        }
                    } else {
                        label.innerHTML = label.innerHTML.replace(/<span[^>]*>\*<\/span>/g, '');
                    }
                }
            });
        }
        
        // Mensajes personalizados para el campo Descripción usando UI nativa
        (function() {
            const descripcionField = document.getElementById('{{ form.descripcion.id_for_label }}') || document.querySelector('[name="descripcion"]');
            if (!descripcionField) return;
            
            const setDescripcionMessage = () => {
                // Limpia mensaje previo para evaluar flags actuales
                descripcionField.setCustomValidity('');
                const v = descripcionField.validity;
                if (v.valueMissing) {
                    descripcionField.setCustomValidity('Este campo es obligatorio.');
                } else if (v.tooShort) {
                    descripcionField.setCustomValidity('Debe ingresar al menos 20 caracteres.');
                } else {
                    descripcionField.setCustomValidity('');
                }
            };
            
            descripcionField.addEventListener('input', setDescripcionMessage);
            descripcionField.addEventListener('invalid', setDescripcionMessage);
            // Inicializa por si el navegador marca inválido al cargar
            setDescripcionMessage();
        })();
        
        // Validación antes de enviar: primero validación nativa, luego archivos
        document.querySelector('form').addEventListener('submit', function(e) {
            // Primero, dejar que el navegador valide los campos nativos (required, minlength, etc.)
            if (!this.checkValidity()) {
                e.preventDefault();
                // Ubicar el primer campo inválido
                const firstInvalid = this.querySelector(':invalid');
                if (firstInvalid) {
                    // Scroll al centro para que el tooltip no quede fuera de vista
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    // Esperar un instante a que termine el scroll y luego forzar el tooltip
                    setTimeout(() => {
                        try { firstInvalid.focus({ preventScroll: true }); } catch (_) { firstInvalid.focus(); }
                        // Mostrar el tooltip nativo en el control específico
                        if (typeof firstInvalid.reportValidity === 'function') {
                            firstInvalid.reportValidity();
                        } else if (typeof this.reportValidity === 'function') {
                            this.reportValidity();
                        }
                    }, 250);
                } else if (typeof this.reportValidity === 'function') {
                    // Fallback si no se encontró el control inválido
                    this.reportValidity();
                }
                return false;
            }
            // Validación personalizada: al menos un archivo
            const fileInputs = document.querySelectorAll('input[type="file"]');
            let hasFile = false;
            fileInputs.forEach(input => {
                if (input.files.length > 0) {
                    hasFile = true;
                }
            });
            if (!hasFile) {
                e.preventDefault();
                alert('⚠️ Debes subir al menos un archivo (imagen o video) como evidencia del reclamo.');
                // Scroll al primer input de archivo
                const firstFileInput = document.querySelector('input[type="file"]');
                if (firstFileInput) {
                    firstFileInput.closest('.form-content').scrollIntoView({ behavior: 'smooth', block: 'start' });
                    firstFileInput.focus();
                }
                return false;
            }
        });
        
        // ========================================
        // DETECTAR TIPO DE ARCHIVO
        // ========================================
        function detectarTipoArchivo(inputElement) {
            if (!inputElement.files || inputElement.files.length === 0) return;
            
            const archivo = inputElement.files[0];
            const nombre = archivo.name.toLowerCase();
            const tipo = archivo.type || '';
            
            // Determinar si es imagen o video
            let tipoArchivo = 'image';  // Por defecto imagen
            
            if (tipo.startsWith('video/') || 
                nombre.endsWith('.mp4') || 
                nombre.endsWith('.mov') || 
                nombre.endsWith('.avi') ||
                nombre.endsWith('.mkv')) {
                tipoArchivo = 'video';
            }
            
            // Encontrar el campo tipo oculto y asignarle el valor
            const form = inputElement.closest('.formset-form');
            const tipoInput = form.querySelector('input[name$="-tipo"]');
            
            if (tipoInput) {
                tipoInput.value = tipoArchivo;
                console.log(`Tipo detectado: ${tipoArchivo} para archivo: ${nombre}`);
            }
        }
        
        // Agregar event listener a todos los inputs de archivo existentes y nuevos
        function agregarDetectorTipo() {
            document.querySelectorAll('input[name$="-archivo"]').forEach(input => {
                // Remover listener anterior si existe
                input.removeEventListener('change', function() {
                    detectarTipoArchivo(this);
                });
                // Agregar listener nuevo
                input.addEventListener('change', function() {
                    detectarTipoArchivo(this);
                });
            });
        }
        
        // Llamar función inicial
        agregarDetectorTipo();
        
        // Cuando se agrega un nuevo formulario, también agregar detector de tipo
        const originalAddForm = window.addForm;
        window.addForm = function() {
            originalAddForm.call(this);
            agregarDetectorTipo();
        };
        
        // ========================================
        // CARGA DINÁMICA DE TÉCNICOS DISPONIBLES
        // ========================================
        let tecnicoSeleccionadoId = null;
        
        // Detectar cambios en Categoría
        const categoriaSelect = document.getElementById('{{ form.categoria.id_for_label }}');
        
        console.log('ID buscado:', '{{ form.categoria.id_for_label }}');
        console.log('Elemento encontrado:', categoriaSelect);
        
        // Si no lo encuentra por id_for_label, buscar por name
        let categoriaSelectActual = categoriaSelect;
        if (!categoriaSelectActual) {
            categoriaSelectActual = document.querySelector('[name="categoria"]');
            console.log('Buscado por name="categoria":', categoriaSelectActual);
        }
        
        if (categoriaSelectActual) {
            categoriaSelectActual.addEventListener('change', cargarTecnicos);
            
            // Cargar técnicos si ya hay un valor seleccionado (por ejemplo, si hay errores en el form)
            if (categoriaSelectActual.value) {
                cargarTecnicos();
            }
        } else {
            console.error('No se encontró el campo de categoría');
        }
        
        function cargarTecnicos() {
            const categoriaId = categoriaSelectActual.value;
            // Solo cargar si la categoría está seleccionada
            if (!categoriaId) {
                document.getElementById('tecnicos-section').style.display = 'none';
                document.getElementById('disclaimer-visita').style.display = 'none';
                return;
            }

            // Obtener el proyecto seleccionado
            const proyectoSelect = document.getElementById('{{ form.id_proyecto.id_for_label }}');
            const proyectoId = proyectoSelect ? proyectoSelect.value : '';

            // Mostrar sección y loading (pero NO el disclaimer aún)
            document.getElementById('tecnicos-section').style.display = 'block';
            document.getElementById('disclaimer-visita').style.display = 'none';
            document.getElementById('tecnicos-loading').style.display = 'block';
            document.getElementById('tecnicos-list').innerHTML = '';
            document.getElementById('sin-tecnicos').style.display = 'none';

            // Construir URL con proyecto_id si está disponible
            let url = `/api/tecnicos/?categoria_id=${categoriaId}`;
            if (proyectoId) {
                url += `&proyecto_id=${proyectoId}`;
            }

            // Hacer petición AJAX
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('tecnicos-loading').style.display = 'none';
                    if (!data.tecnicos || data.tecnicos.length === 0) {
                        document.getElementById('sin-tecnicos').style.display = 'block';
                        return;
                    }
                    // Renderizar técnicos
                    const tecnicosList = document.getElementById('tecnicos-list');
                    data.tecnicos.forEach(tecnico => {
                        const card = crearTarjetaTecnico(tecnico);
                        tecnicosList.appendChild(card);
                    });
                })
                .catch(error => {
                    document.getElementById('tecnicos-loading').style.display = 'none';
                    document.getElementById('sin-tecnicos').style.display = 'block';
                });
        }
        
        function crearTarjetaTecnico(tecnico) {
            const card = document.createElement('div');
            card.className = 'tecnico-card';
            card.dataset.tecnicoId = tecnico.id;
            

        
            
            // Crear HTML de disponibilidad semanal
            let disponibilidadSemanalHtml = '';
            if (tecnico.disponibilidad_semanal && tecnico.disponibilidad_semanal.length > 0) {
                disponibilidadSemanalHtml = tecnico.disponibilidad_semanal.map(disp => {
                    const horariosDelDia = disp.horarios.map(h => 
                        `${h.hora_inicio}-${h.hora_fin}`
                    ).join(', ');
                    return `
                        <div style="padding: 8px 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 6px; border-left: 3px solid #2A6D6D;">
                            <strong style="color: #1A4D4D; font-size: 13px;">${disp.dia}</strong><br>
                            <small style="color: #666; font-size: 12px;">⏰ ${horariosDelDia}</small>
                        </div>
                    `;
                }).join('');
            } else {
                disponibilidadSemanalHtml = '<p style="color: #999; font-size: 12px; text-align: center;">Sin horarios configurados</p>';
            }
            
            // AGRUPAR horarios por fecha con diseño horizontal de días
            let horariosHtml = '';
            if (tecnico.tiene_disponibilidad && tecnico.proximos_horarios.length > 0) {
                // Agrupar horarios por fecha
                const horariosPorFecha = {};
                tecnico.proximos_horarios.forEach(h => {
                    const fechaKey = h.fecha;
                    if (!horariosPorFecha[fechaKey]) {
                        horariosPorFecha[fechaKey] = {
                            dia_nombre: h.dia_nombre,
                            fecha_formateada: h.fecha_formateada,
                            fecha: h.fecha,
                            horarios: []
                        };
                    }
                    horariosPorFecha[fechaKey].horarios.push({
                        hora_inicio: h.hora_inicio,
                        hora_fin: h.hora_fin
                    });
                });
                
                const gruposArray = Object.values(horariosPorFecha);
                const tecnicoIdUnico = 'tecnico_' + tecnico.id;
                
                // Crear pestañas de días (horizontal)
                const tabsHtml = gruposArray.map((grupo, index) => {
                    const tabId = tecnicoIdUnico + '_tab_' + index;
                    const isFirst = index === 0;
                    return '<div class="tab-dia" data-tab-id="' + tabId + '" ' +
                           'onclick="seleccionarDia(event, \'' + tecnicoIdUnico + '\', ' + index + ')" ' +
                           'style="display: inline-block; padding: 10px 16px; margin: 0 4px 4px 0; cursor: pointer; border-radius: 8px 8px 0 0; ' +
                           'background: ' + (isFirst ? '#4caf50' : '#e0e0e0') + '; ' +
                           'color: ' + (isFirst ? 'white' : '#666') + '; ' +
                           'font-weight: ' + (isFirst ? 'bold' : 'normal') + '; ' +
                           'border: 2px solid ' + (isFirst ? '#4caf50' : '#e0e0e0') + '; ' +
                           'transition: all 0.3s;">' +
                           '<div style="font-size: 13px;">' + grupo.dia_nombre + '</div>' +
                           '<div style="font-size: 11px; opacity: 0.9;">' + grupo.fecha_formateada + '</div>' +
                           '</div>';
                }).join('');
                
                // Crear contenido de horarios (vertical)
                const contenidoHtml = gruposArray.map((grupo, index) => {
                    const tabId = tecnicoIdUnico + '_tab_' + index;
                    const isFirst = index === 0;
                    
                    const horariosDelDia = grupo.horarios.map(h => {
                        const horaInicioCorta = h.hora_inicio.substring ? h.hora_inicio.substring(0,5) : h.hora_inicio;
                        const horaFinCorta = h.hora_fin.substring ? h.hora_fin.substring(0,5) : h.hora_fin;
                        const fechaTexto = grupo.dia_nombre + ' ' + grupo.fecha_formateada + ' ' + horaInicioCorta;
                        
                        return '<div class="horario-slot" ' +
                               'style="padding: 12px 16px; margin: 6px 0; background: #e8f5e9; border: 2px solid #4caf50; ' +
                               'border-radius: 8px; cursor: pointer; transition: all 0.2s; text-align: center; font-size: 14px;" ' +
                               'onmouseover="if(!this.classList.contains(\'selected\')) { this.style.background=\'#c8e6c9\'; this.style.transform=\'translateX(5px)\'; }" ' +
                               'onmouseout="if(!this.classList.contains(\'selected\')) { this.style.background=\'#e8f5e9\'; this.style.transform=\'translateX(0)\'; }" ' +
                               'onclick="seleccionarHorario(event, ' + tecnico.id + ', \'' + grupo.fecha + '\', \'' + h.hora_inicio + '\', \'' + h.hora_fin + '\', \'' + tecnico.nombre + '\', \'' + fechaTexto + '\')">' +
                               '<strong>⏰ ' + horaInicioCorta + ' - ' + horaFinCorta + '</strong>' +
                               '</div>';
                    }).join('');
                    
                    return '<div class="tab-content" data-tab-id="' + tabId + '" ' +
                           'style="display: ' + (isFirst ? 'block' : 'none') + '; ' +
                           'width: 100%; padding: 16px; background: #f8f9fa; border-radius: 0 8px 8px 8px; border: 2px solid #e0e0e0; border-top: none; box-sizing: border-box;">' +
                           horariosDelDia +
                           '</div>';
                }).join('');
                
                horariosHtml = '<div class="tabs-container" data-tecnico-id="' + tecnicoIdUnico + '" style="width: 100%;">' +
                               '<div class="tabs-header" style="width: 100%; border-bottom: 2px solid #e0e0e0; overflow-x: auto; white-space: nowrap; box-sizing: border-box;">' +
                               tabsHtml +
                               '</div>' +
                               '<div class="tabs-body" style="width: 100%;">' +
                               contenidoHtml +
                               '</div>' +
                               '</div>' +
                               '<p style="text-align: center; margin-top: 10px; color: #666; font-size: 12px;">Selecciona un día y luego haz clic en un horario</p>';
            } else {
                horariosHtml = '<div class="horario-mini" style="border-color: #ffc107; background: #fff3cd;">⚠️ Sin horarios próximos</div>';
            }
            
            card.innerHTML =
                '<div class="tecnico-header">' +
                    '<div class="tecnico-foto">' +
                        (tecnico.foto_url
                            ? ('<img src="' + tecnico.foto_url + '" alt="' + tecnico.nombre + '">')
                            : tecnico.iniciales
                        ) +
                    '</div>' +
                    '<div class="tecnico-info">' +
                        '<h4>' + tecnico.nombre + '</h4>' +
                        '<div class="tecnico-especialidad">' +
                             tecnico.especialidad +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="tecnico-horarios">' +
                    '<h5>Próximas Fechas Disponibles (' + tecnico.proximos_horarios.length + ')</h5>' +
                    '<div style="max-height: 200px; overflow-y: auto; padding-right: 5px;">' +
                        horariosHtml +
                    '</div>' +
                '</div>';
            
            return card;
        }
        
        function seleccionarHorario(event, tecnicoId, fecha, horaInicio, horaFin, tecnicoNombre, fechaTexto) {
            event.stopPropagation(); // Evitar propagación del click
            
            // Remover selección anterior de TODOS los horarios clickeables (solo .horario-slot, NO los tabs)
            document.querySelectorAll('.horario-slot').forEach(h => {
                h.classList.remove('selected');
                h.style.background = '#e8f5e9';
                h.style.borderColor = '#4caf50';
                h.style.color = '#000';
                h.style.fontWeight = 'normal';
                h.style.transform = 'translateX(0)';
                h.style.boxShadow = 'none';
            });
            
            // Marcar horario seleccionado con clase CSS
            event.currentTarget.classList.add('selected');
            event.currentTarget.style.background = '#2e7d32';
            event.currentTarget.style.borderColor = '#1b5e20';
            event.currentTarget.style.color = 'white';
            event.currentTarget.style.fontWeight = 'bold';
            event.currentTarget.style.transform = 'scale(1.05)';
            event.currentTarget.style.boxShadow = '0 4px 12px rgba(46, 125, 50, 0.4)';
            
            // Guardar selección en campos ocultos del formulario
            document.getElementById('tecnico_id_hidden').value = tecnicoId;
            document.getElementById('fecha_cita_hidden').value = fecha;
            document.getElementById('hora_inicio_hidden').value = horaInicio;
            document.getElementById('hora_fin_hidden').value = horaFin;
            
            // También guardar en window para referencia
            tecnicoSeleccionadoId = tecnicoId;
            window.horarioSeleccionado = {
                fecha: fecha,
                hora_inicio: horaInicio,
                hora_fin: horaFin
            };
            
            // Actualizar botón de submit
            const submitBtn = document.querySelector('.btn-submit');
            submitBtn.textContent = `✓ Confirmar visita con ${tecnicoNombre} - ${fechaTexto}`;
            submitBtn.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
            
            // MOSTRAR EL DISCLAIMER después de seleccionar horario
            const disclaimer = document.getElementById('disclaimer-visita');
            disclaimer.style.display = 'block';
            
            // Scroll suave hacia el disclaimer primero
            disclaimer.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Después de 1 segundo, scroll hacia el botón
            setTimeout(() => {
                submitBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 1000);
        }
        
        function seleccionarDia(event, tecnicoId, tabIndex) {
            event.stopPropagation();
            
            // Obtener el contenedor de tabs del técnico
            const container = document.querySelector('.tabs-container[data-tecnico-id="' + tecnicoId + '"]');
            if (!container) return;
            
            // Resetear todos los tabs del técnico
            const allTabs = container.querySelectorAll('.tab-dia');
            const allContents = container.querySelectorAll('.tab-content');
            
            allTabs.forEach(tab => {
                tab.style.background = '#e0e0e0';
                tab.style.color = '#666';
                tab.style.fontWeight = 'normal';
                tab.style.borderColor = '#e0e0e0';
            });
            
            allContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // Activar el tab seleccionado (verde)
            const selectedTab = allTabs[tabIndex];
            const selectedContent = allContents[tabIndex];
            
            if (selectedTab) {
                selectedTab.style.background = '#4caf50';
                selectedTab.style.color = 'white';
                selectedTab.style.fontWeight = 'bold';
                selectedTab.style.borderColor = '#4caf50';
            }
            
            if (selectedContent) {
                selectedContent.style.display = 'block';
            }
        }
        
        function seleccionarTecnico(tecnicoId) {
            // Esta función ya no se usa, la selección se hace por horario
        }
    </script>

{% endblock %}