{% extends 'base.html' %}
{% load static %}

{% block title %}Detalle Reclamo - Supervisión{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                    <h1 class="h2" style="color: #1A4D4D;">
                        <i class="fas fa-file-alt"></i> Reclamo #{{ reclamo.id_reclamo }}
                    </h1>
                    <p class="text-muted mb-0"><strong>Propietario:</strong> {{ reclamo.propietario.nombre }}</p>
                </div>
                <a href="{% url 'supervisor_reclamos' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
            <p class="text-muted">Detalle completo del reclamo para supervisión</p>
        </div>
    </div>

    <!-- Estado General -->
    <div class="alert alert-info mb-4" role="alert">
        <strong>Estado Actual:</strong>
        <span class="badge" style="background-color: #1A4D4D; font-size: 1rem;">
            {{ reclamo.get_estado_display }}
        </span>
    </div>

    <!-- Información Principal -->
    <div class="row mb-4">
        <!-- Datos del Reclamo -->
        <div class="col-md-6">
            <div class="card" style="border-top: 3px solid #1A4D4D;">
                <div class="card-header" style="background-color: #E8F4F8;">
                    <h6 class="mb-0" style="color: #1A4D4D;">
                        <i class="fas fa-clipboard-list"></i> Información del Reclamo
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted"><strong>ID Reclamo:</strong></small>
                        <p class="mb-0">#{{ reclamo.id_reclamo }}</p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted"><strong>Descripción Falla:</strong></small>
                        <p class="mb-0">{{ reclamo.descripcion }}</p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted"><strong>Descripción Solución:</strong></small>
                        <p class="mb-0">{{ reclamo.resolucion|default:"No especificada" }}</p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted"><strong>Fecha de Ingreso:</strong></small>
                        <p class="mb-0">{{ reclamo.fecha_ingreso|date:"d/m/Y H:i" }}</p>
                    </div>
                    {% if reclamo.fecha_resolucion %}
                        <div class="mb-3">
                            <small class="text-muted"><strong>Fecha de Resolución:</strong></small>
                            <p class="mb-0">{{ reclamo.fecha_resolucion|date:"d/m/Y H:i" }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Datos del Propietario -->
        <div class="col-md-6">
            <div class="card" style="border-top: 3px solid #1A4D4D;">
                <div class="card-header" style="background-color: #E8F4F8;">
                    <h6 class="mb-0" style="color: #1A4D4D;">
                        <i class="fas fa-user"></i> Información del Propietario
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <small class="text-muted"><strong>Nombre Completo:</strong></small>
                        <p class="mb-0">
                            {% if reclamo.propietario %}
                                {{ reclamo.propietario.nombre }}
                            {% else %}
                                <span class="text-danger">No especificado</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted"><strong>RUT:</strong></small>
                        <p class="mb-0">{{ reclamo.propietario.rut }}</p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted"><strong>Email:</strong></small>
                        <p class="mb-0"><a href="mailto:{{ reclamo.propietario.email }}">{{ reclamo.propietario.email }}</a></p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted"><strong>Teléfono:</strong></small>
                        <p class="mb-0">{{ reclamo.propietario.telefono }}</p>
                    </div>
                    <div class="mb-3">
                        <small class="text-muted"><strong>Dirección:</strong></small>
                        <p class="mb-0">{{ reclamo.proyecto.direccion|default:"No especificada" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Información de Proyecto y Asignación -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card" style="border-top: 3px solid #1A4D4D;">
                <div class="card-header" style="background-color: #E8F4F8;">
                    <h6 class="mb-0" style="color: #1A4D4D;">
                        <i class="fas fa-building"></i> Proyecto
                    </h6>
                </div>
                <div class="card-body">
                    <p><strong>{{ reclamo.proyecto.nombre }}</strong></p>
                    <small class="text-muted">{{ reclamo.proyecto.constructora.razon_social }}</small>
                    {% if reclamo.unidad %}
                        <p class="mt-2"><strong>Unidad:</strong> {{ reclamo.unidad }}</p>
                    {% endif %}
                    {% if reclamo.ubicacion_especifica %}
                        <p class="mt-2"><strong>Ubicación:</strong> {{ reclamo.ubicacion_especifica }}</p>
                    {% elif reclamo.propietario.direccion %}
                        <p class="mt-2"><strong>Dirección:</strong> {{ reclamo.propietario.direccion }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card" style="border-top: 3px solid #1A4D4D;">
                <div class="card-header" style="background-color: #E8F4F8;">
                    <h6 class="mb-0" style="color: #1A4D4D;">
                        <i class="fas fa-tools"></i> Técnico Asignado
                    </h6>
                </div>
                <div class="card-body">
                    {% if reclamo.tecnico_asignado %}
                        <p><strong>{{ reclamo.tecnico_asignado.nombre }}</strong></p>
                        <small class="text-muted">{{ reclamo.tecnico_asignado.especialidad.nombre }}</small>
                    {% else %}
                        <span class="badge bg-warning">Sin asignar</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Historial de Citas -->
    {% if citas %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background-color: #1A4D4D; color: white;">
                        <h6 class="mb-0"><i class="fas fa-calendar"></i> Historial de Citas ({{ citas.count }})</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th>Propietario</th>
                                    <th>Técnico</th>
                                    <th class="text-center">Fecha Programada</th>
                                    <th class="text-center">Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cita in citas %}
                                    <tr>
                                        <td class="text-center"><strong>#{{ cita.id_cita }}</strong></td>
                                        <td>{{ cita.id_cliente.nombre }}</td>
                                        <td>{{ cita.id_tecnico.nombre }}</td>
                                        <td class="text-center">{{ cita.fecha_programada|date:"d/m/Y H:i" }}</td>
                                        <td class="text-center">
                                            <span class="badge {% if cita.estado == 'pendiente' %}bg-warning{% elif cita.estado == 'confirmada' %}bg-info{% elif cita.estado == 'completada' %}bg-success{% else %}bg-danger{% endif %}">
                                                {{ cita.get_estado_display }}
                                            </span>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Historial de Visitas Técnicas (Resolución de Citas) -->
    {% if visitas_tecnicas %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background-color: #1A4D4D; color: white;">
                        <h6 class="mb-0"><i class="fas fa-user-check"></i> Historial de Visitas Técnicas - Resolución de Citas ({{ visitas_tecnicas.count }})</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th>Técnico</th>
                                    <th class="text-center">Fecha Programada</th>
                                    <th class="text-center">Inicio</th>
                                    <th class="text-center">Cierre</th>
                                    <th class="text-center">Duración</th>
                                    <th>Resolución</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for visita in visitas_tecnicas %}
                                    <tr>
                                        <td class="text-center"><strong>#{{ visita.id_visita }}</strong></td>
                                        <td>{{ visita.id_tecnico.nombre }}</td>
                                        <td class="text-center">
                                            {% if visita.id_cita %}
                                                {{ visita.id_cita.fecha_programada|date:"d/m/Y H:i" }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-center">{{ visita.fecha_visita|date:"d/m/Y H:i" }}</td>
                                        <td class="text-center">{{ visita.fecha_cierre|date:"d/m/Y H:i"|default:"-" }}</td>
                                        <td class="text-center">
                                            {% if visita.duracion_calculada %}
                                                {{ visita.duracion_calculada }} min
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td><small>{{ reclamo.resolucion|truncatewords:15|default:"-" }}</small></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Materiales Usados -->
    {% if materiales_usados %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background-color: #1A4D4D; color: white;">
                        <h6 class="mb-0"><i class="fas fa-tools"></i> Materiales Usados ({{ materiales_usados.count }})</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th>Material</th>
                                    <th class="text-center">Cantidad</th>
                                    <th>Unidad</th>
                                    <th class="text-center">Costo Unitario</th>
                                    <th class="text-center">Total</th>
                                    <th>Observaciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for uso in materiales_usados %}
                                    <tr>
                                        <td class="text-center"><strong>#{{ uso.id_uso }}</strong></td>
                                        <td>{{ uso.id_material.nombre }}</td>
                                        <td class="text-center">{{ uso.cantidad_usada }}</td>
                                        <td>{{ uso.id_material.unidad_medida|default:"-" }}</td>
                                        <td class="text-center">${{ uso.id_material.costo_unitario }}</td>
                                        <td class="text-center"><strong>${{ uso.total }}</strong></td>
                                        <td><small>{{ uso.observaciones|default:"-" }}</small></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Evidencia Fotográfica - Propietario -->
    {% if archivos_evidencia %}
        {% with fotos_propietario=archivos_evidencia|dictsortreversed:"subido_por" %}
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header" style="background-color: #1A4D4D; color: white;">
                            <h6 class="mb-0"><i class="fas fa-camera"></i> Evidencia Fotográfica - Propietario</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                {% for archivo in archivos_evidencia %}
                                    {% if archivo.archivo and archivo.subido_por == 'cliente' %}
                                        <div class="col-md-3">
                                            <div class="position-relative" style="overflow: hidden; border-radius: 8px; background-color: #f0f0f0; height: 180px;">
                                                <a href="{{ archivo.archivo.url }}" target="_blank" onclick="abrirVisorImagen('{{ archivo.archivo.url }}'); return false;" style="text-decoration: none;">
                                                    <img src="{{ archivo.archivo.url }}" alt="Evidencia" class="w-100 h-100" style="object-fit: cover; cursor:pointer;">
                                                    <div class="position-absolute bottom-0 start-0 end-0 p-2" style="background: rgba(0,0,0,0.7);">
                                                        <small class="text-white">{{ archivo.fecha_subida|date:"d/m/Y" }}</small>
                                                        <span class="text-white float-end"><i class="fas fa-search-plus"></i></span>
                                                    </div>
                                                </a>
                                            </div>
                                            <small class="text-muted mt-2 d-block">{{ archivo.descripcion|default:"Foto de evidencia" }}</small>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if not archivos_evidencia|dictsortreversed:"subido_por" %}
                                <p class="text-muted text-center">No hay fotos del propietario</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endwith %}
    {% endif %}

    <!-- Evidencia Fotográfica - Técnico -->
    {% if archivos_evidencia %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background-color: #1A4D4D; color: white;">
                        <h6 class="mb-0"><i class="fas fa-camera"></i> Evidencia Fotográfica - Técnico</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            {% for archivo in archivos_evidencia %}
                                {% if archivo.archivo and archivo.subido_por == 'tecnico' %}
                                    <div class="col-md-3">
                                        <div class="position-relative" style="overflow: hidden; border-radius: 8px; background-color: #f0f0f0; height: 180px;">
                                            <a href="{{ archivo.archivo.url }}" target="_blank" onclick="abrirVisorImagen('{{ archivo.archivo.url }}'); return false;" style="text-decoration: none;">
                                                <img src="{{ archivo.archivo.url }}" alt="Evidencia" class="w-100 h-100" style="object-fit: cover; cursor:pointer;">
                                                <div class="position-absolute bottom-0 start-0 end-0 p-2" style="background: rgba(0,0,0,0.7);">
                                                    <small class="text-white">{{ archivo.fecha_subida|date:"d/m/Y" }}</small>
                                                    <span class="text-white float-end"><i class="fas fa-search-plus"></i></span>
                                                </div>
                                            </a>
                                        </div>
                                        <small class="text-muted mt-2 d-block">{{ archivo.descripcion|default:"Foto de evidencia" }}</small>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% with tecnico_fotos=archivos_evidencia %}
                            {% if not tecnico_fotos %}
                                <p class="text-muted text-center">No hay fotos del técnico</p>
                            {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
<!-- Visor Modal para Imágenes -->
<div id="visor" onclick="cerrarVisor()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; z-index:2000; backdrop-filter:blur(3px);">
    <img src="" alt="Vista ampliada" style="display:none; max-width:90%; max-height:90%; border-radius:18px; box-shadow:0 6px 25px rgba(0,0,0,0.5);">
</div>
{% block scripts %}
<script>
// === Evidencias: visor de imágenes ===
function abrirVisorImagen(src) {
    const visor = document.getElementById('visor');
    const img = visor.querySelector('img');
    img.src = src; img.style.display = 'block';
    visor.style.display = 'flex';
    setTimeout(() => visor.classList.add('mostrar'), 10);
}
function cerrarVisor() {
    const visor = document.getElementById('visor');
    const img = visor.querySelector('img');
    visor.classList.remove('mostrar');
    setTimeout(() => {
        visor.style.display = 'none';
        img.src = '';
        img.style.display = 'none';
    }, 200);
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') cerrarVisor(); });
</script>
{% endblock %}

    <!-- Gestión de Escombros -->
    {% if gestiones_escombros %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background-color: #1A4D4D; color: white;">
                        <h6 class="mb-0"><i class="fas fa-trash"></i> Gestión de Escombros ({{ gestiones_escombros.count }})</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th>Tipo</th>
                                    <th class="text-center">Volumen (m³)</th>
                                    <th class="text-center">Estado</th>
                                    <th class="text-center">Fecha Programada</th>
                                    <th class="text-center">Empresa Retiro</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for gestion in gestiones_escombros %}
                                    <tr>
                                        <td class="text-center"><strong>#{{ gestion.id_escombro }}</strong></td>
                                        <td>{{ gestion.get_tipo_escombro_display }}</td>
                                        <td class="text-center">{{ gestion.volumen_m3 }}</td>
                                        <td class="text-center">
                                            <span class="badge {% if gestion.estado == 'pendiente' %}bg-warning{% elif gestion.estado == 'programado' %}bg-info{% elif gestion.estado == 'completado' %}bg-success{% else %}bg-danger{% endif %}">
                                                {{ gestion.get_estado_display }}
                                            </span>
                                        </td>
                                        <td class="text-center">{{ gestion.fecha_programada_retiro|date:"d/m/Y"|default:"-" }}</td>
                                        <td class="text-center">
                                            {% if gestion.id_empresa_retiro %}
                                                {{ gestion.id_empresa_retiro.nombre }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Encuestas de Satisfacción -->
    {% if encuestas %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header" style="background-color: #1A4D4D; color: white;">
                        <h6 class="mb-0"><i class="fas fa-star"></i> Encuestas de Satisfacción ({{ encuestas.count }})</h6>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th class="text-center">ID</th>
                                    <th class="text-center">Fecha</th>
                                    <th class="text-center">Puntuación</th>
                                    <th class="text-center">Solución</th>
                                    <th class="text-center">Técnico</th>
                                    <th class="text-center">Tiempo</th>
                                    <th>Comentarios</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for encuesta in encuestas %}
                                    <tr>
                                        <td class="text-center"><strong>#{{ encuesta.id_encuesta }}</strong></td>
                                        <td class="text-center">{{ encuesta.fecha_respuesta|date:"d/m/Y"|default:"-" }}</td>
                                        <td class="text-center">
                                            {% if encuesta.puntuacion %}
                                                <strong>{{ encuesta.puntuacion }}/5</strong>
                                            {% else %}
                                                <span class="badge bg-secondary">Pendiente</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if encuesta.calificacion_solucion %}
                                                <strong>{{ encuesta.calificacion_solucion }}/5</strong>
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if encuesta.calificacion_tecnico %}
                                                <strong>{{ encuesta.calificacion_tecnico }}/5</strong>
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if encuesta.calificacion_tiempo %}
                                                <strong>{{ encuesta.calificacion_tiempo }}/5</strong>
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td><small>{{ encuesta.comentarios|truncatewords:15|default:"-" }}</small></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

</div>

<style>
    .btn-elegante {
        background: linear-gradient(135deg, #1A4D4D 0%, #2A6D6D 100%);
        color: white;
        border: none;
    }

    .btn-elegante:hover {
        background: linear-gradient(135deg, #0F3333 0%, #1A4D4D 100%);
        color: white;
    }
</style>
{% endblock %}
